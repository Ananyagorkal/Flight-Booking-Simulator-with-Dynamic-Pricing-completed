<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - Flight Booking Simulator</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .payment-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .payment-section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .payment-method {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .payment-method:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        .payment-method.selected {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
        .payment-method input[type="radio"] {
            margin-right: 15px;
        }
        .bank-options {
            display: none;
            margin-top: 15px;
        }
        .bank-options.show {
            display: block;
        }
        .bank-option {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 5px 0;
            cursor: pointer;
        }
        .bank-option:hover {
            background-color: #f8f9fa;
        }
        .bank-option.selected {
            background-color: #e3f2fd;
            border-color: #007bff;
        }
        .booking-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
        }
        .summary-row.total {
            font-weight: bold;
            font-size: 1.2em;
            border-top: 2px solid #007bff;
            padding-top: 10px;
        }
        .btn-pay {
            background: #28a745;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }
        .btn-pay:hover {
            background: #218838;
        }
        .btn-pay:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>✈️ Flight Booking Simulator</h1>
            <nav>
                <a href="index.html">Search Flights</a>
                <a href="payment.html" class="active">Payment</a>
            </nav>
        </header>

        <div class="payment-container">
            <h2>Payment Details</h2>
            
            <!-- Booking Summary -->
            <div class="booking-summary">
                <h3>Booking Summary</h3>
                <div id="bookingSummary">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Payment Methods -->
            <div class="payment-section">
                <h3>Select Payment Method</h3>
                <div id="paymentMethods">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Bank Selection (for Net Banking) -->
            <div class="payment-section" id="bankSection" style="display: none;">
                <h3>Select Bank</h3>
                <div id="bankOptions">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Payment Form -->
            <div class="payment-section">
                <h3>Payment Information</h3>
                <form id="paymentForm">
                    <div id="cardDetails" style="display: none;">
                        <div class="form-group">
                            <label>Card Number</label>
                            <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Expiry Date</label>
                                <input type="text" id="expiryDate" placeholder="MM/YY" maxlength="5">
                            </div>
                            <div class="form-group">
                                <label>CVV</label>
                                <input type="text" id="cvv" placeholder="123" maxlength="3">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Cardholder Name</label>
                            <input type="text" id="cardholderName" placeholder="John Doe">
                        </div>
                    </div>

                    <div id="upiDetails" style="display: none;">
                        <div class="form-group">
                            <label>UPI ID</label>
                            <input type="text" id="upiId" placeholder="yourname@paytm">
                        </div>
                    </div>

                    <div id="walletDetails" style="display: none;">
                        <div class="form-group">
                            <label>Wallet</label>
                            <select id="walletType">
                                <option value="paytm">Paytm</option>
                                <option value="phonepe">PhonePe</option>
                                <option value="gpay">Google Pay</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Pay Button -->
            <button class="btn-pay" id="payButton" onclick="processPayment()">
                Pay Now
            </button>
        </div>
    </div>

    <script>
        let selectedPaymentMethod = null;
        let selectedBank = null;
        let bookingData = null;

        // Load booking data from localStorage
        function loadBookingData() {
            const data = localStorage.getItem('bookingData');
            if (data) {
                bookingData = JSON.parse(data);
                displayBookingSummary();
            } else {
                alert('No booking data found. Please go back to search flights.');
                window.location.href = 'index.html';
            }
        }

        // Display booking summary
        function displayBookingSummary() {
            if (!bookingData) return;

            const summary = document.getElementById('bookingSummary');
            const flight = bookingData.flight;
            const passengers = bookingData.passengers;
            const seatClass = bookingData.seatClass;
            const price = bookingData.price;
            const coupon = bookingData.coupon;

            summary.innerHTML = `
                <div class="summary-row">
                    <span>Flight:</span>
                    <span>${flight.flight_number} (${flight.airline.name})</span>
                </div>
                <div class="summary-row">
                    <span>Route:</span>
                    <span>${flight.departure_airport.code} → ${flight.arrival_airport.code}</span>
                </div>
                <div class="summary-row">
                    <span>Passengers:</span>
                    <span>${passengers} × ${seatClass}</span>
                </div>
                <div class="summary-row">
                    <span>Base Price:</span>
                    <span>₹${price.toFixed(0)}</span>
                </div>
                ${coupon ? `
                <div class="summary-row">
                    <span>Coupon (${coupon.code}):</span>
                    <span>-₹${(price - bookingData.finalPrice).toFixed(0)}</span>
                </div>
                ` : ''}
                <div class="summary-row total">
                    <span>Total Amount:</span>
                    <span>₹${bookingData.finalPrice.toFixed(0)}</span>
                </div>
            `;
        }

        // Load payment methods
        async function loadPaymentMethods() {
            try {
                const response = await fetch('http://localhost:8000/api/payments/methods');
                const data = await response.json();
                
                const container = document.getElementById('paymentMethods');
                container.innerHTML = '';

                data.payment_methods.forEach(method => {
                    const div = document.createElement('div');
                    div.className = 'payment-method';
                    div.innerHTML = `
                        <input type="radio" name="paymentMethod" value="${method.id}" onchange="selectPaymentMethod('${method.type}')">
                        <span>${method.name}</span>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading payment methods:', error);
                // Fallback payment methods
                const fallbackMethods = [
                    { id: 'card', name: 'Credit/Debit Card', type: 'card' },
                    { id: 'netbanking', name: 'Net Banking', type: 'netbanking' },
                    { id: 'upi', name: 'UPI', type: 'upi' },
                    { id: 'wallet', name: 'Wallet', type: 'wallet' }
                ];
                
                fallbackMethods.forEach(method => {
                    const div = document.createElement('div');
                    div.className = 'payment-method';
                    div.innerHTML = `
                        <input type="radio" name="paymentMethod" value="${method.id}" onchange="selectPaymentMethod('${method.type}')">
                        <span>${method.name}</span>
                    `;
                    container.appendChild(div);
                });
            }
        }

        // Select payment method
        function selectPaymentMethod(type) {
            selectedPaymentMethod = type;
            
            // Hide all payment details
            document.getElementById('cardDetails').style.display = 'none';
            document.getElementById('upiDetails').style.display = 'none';
            document.getElementById('walletDetails').style.display = 'none';
            document.getElementById('bankSection').style.display = 'none';

            // Show relevant details
            if (type === 'card') {
                document.getElementById('cardDetails').style.display = 'block';
            } else if (type === 'upi') {
                document.getElementById('upiDetails').style.display = 'block';
            } else if (type === 'wallet') {
                document.getElementById('walletDetails').style.display = 'block';
            } else if (type === 'netbanking') {
                loadBanks();
                document.getElementById('bankSection').style.display = 'block';
            }
        }

        // Load banks
        async function loadBanks() {
            try {
                const response = await fetch('http://localhost:8000/api/payments/banks');
                const data = await response.json();
                
                const container = document.getElementById('bankOptions');
                container.innerHTML = '';

                data.banks.forEach(bank => {
                    const div = document.createElement('div');
                    div.className = 'bank-option';
                    div.innerHTML = `
                        <input type="radio" name="bank" value="${bank.id}" onchange="selectBank('${bank.name}')">
                        <span>${bank.name} (${bank.code})</span>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading banks:', error);
                // Fallback banks
                const fallbackBanks = [
                    { id: 'sbi', name: 'State Bank of India', code: 'SBI' },
                    { id: 'hdfc', name: 'HDFC Bank', code: 'HDFC' },
                    { id: 'icici', name: 'ICICI Bank', code: 'ICICI' },
                    { id: 'axis', name: 'Axis Bank', code: 'AXIS' }
                ];
                
                fallbackBanks.forEach(bank => {
                    const div = document.createElement('div');
                    div.className = 'bank-option';
                    div.innerHTML = `
                        <input type="radio" name="bank" value="${bank.id}" onchange="selectBank('${bank.name}')">
                        <span>${bank.name} (${bank.code})</span>
                    `;
                    container.appendChild(div);
                });
            }
        }

        // Select bank
        function selectBank(bankName) {
            selectedBank = bankName;
        }

        // Process payment
        async function processPayment() {
            if (!selectedPaymentMethod) {
                alert('Please select a payment method');
                return;
            }

            if (selectedPaymentMethod === 'netbanking' && !selectedBank) {
                alert('Please select a bank');
                return;
            }

            const payButton = document.getElementById('payButton');
            payButton.disabled = true;
            payButton.textContent = 'Processing...';

            try {
                // Simulate payment processing
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Generate booking confirmation
                const confirmation = {
                    pnr: 'PNR' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                    booking_reference: 'BK' + Math.random().toString(36).substr(2, 8).toUpperCase(),
                    passenger_name: bookingData.passengerName,
                    passenger_email: bookingData.passengerEmail,
                    passenger_phone: bookingData.passengerPhone,
                    flight_details: bookingData.flight,
                    seat_class: bookingData.seatClass,
                    seat_number: 'A' + Math.floor(Math.random() * 30 + 1),
                    price_paid: bookingData.finalPrice,
                    booking_date: new Date().toISOString(),
                    status: 'CONFIRMED'
                };

                // Store confirmation
                localStorage.setItem('bookingConfirmation', JSON.stringify(confirmation));

                // Redirect to confirmation page
                window.location.href = 'confirmation.html';

            } catch (error) {
                alert('Payment failed. Please try again.');
                payButton.disabled = false;
                payButton.textContent = 'Pay Now';
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadBookingData();
            loadPaymentMethods();
        });
    </script>
</body>
</html>
